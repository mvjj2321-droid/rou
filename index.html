<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>NFC Roulette</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700;900&family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
:root {
  --gold:#c9a84c; --gold-l:#f0d080; --gold-d:#7a5c1e;
  --green:#1a5c2a; --green-l:#2d8a42; --felt:#0d3d1a;
  --bg:#080f0a; --white:#f5f0e8;
  --glow:0 0 20px rgba(201,168,76,0.4);
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
body{background:var(--bg);font-family:'Space Mono',monospace;color:var(--white);min-height:100vh;overflow-x:hidden;}

/* SCREENS */
.screen{display:none;min-height:100vh;flex-direction:column;align-items:center;justify-content:center;padding:18px;}
.screen.active{display:flex;}
#loadScreen,#settingsScreen{justify-content:flex-start;padding-top:22px;overflow-y:auto;}

/* ‚îÄ‚îÄ‚îÄ LOGIN ‚îÄ‚îÄ‚îÄ */
#loginScreen{background:radial-gradient(ellipse at center,#0d2a15 0%,var(--bg) 70%);position:relative;overflow:hidden;}
#loginScreen::before{content:'';position:absolute;inset:0;background:repeating-linear-gradient(45deg,transparent,transparent 40px,rgba(201,168,76,0.025) 40px,rgba(201,168,76,0.025) 41px);}
.casino-title{font-family:'Cinzel Decorative',serif;font-size:clamp(1.9rem,8vw,3.4rem);font-weight:900;color:var(--gold);text-shadow:0 0 40px rgba(201,168,76,0.6),0 2px 0 var(--gold-d);text-align:center;letter-spacing:2px;line-height:1.1;margin-bottom:6px;position:relative;}
.casino-sub{font-family:'Playfair Display',serif;font-style:italic;color:var(--gold-l);opacity:0.65;font-size:0.95rem;margin-bottom:36px;text-align:center;position:relative;}
.nfc-card{background:linear-gradient(135deg,rgba(26,92,42,0.28),rgba(8,15,10,0.82));border:1px solid rgba(201,168,76,0.28);border-radius:20px;padding:34px 26px;width:100%;max-width:350px;text-align:center;box-shadow:0 8px 40px rgba(0,0,0,0.6),inset 0 1px 0 rgba(201,168,76,0.18);position:relative;}
.nfc-ring{width:94px;height:94px;border-radius:50%;background:radial-gradient(circle,rgba(201,168,76,0.12),transparent 70%);border:2px solid rgba(201,168,76,0.35);display:flex;align-items:center;justify-content:center;margin:0 auto 18px;position:relative;cursor:pointer;transition:all .3s;}
.nfc-ring:hover,.nfc-ring.pulse{border-color:var(--gold);box-shadow:var(--glow);}
.nfc-ring.pulse{animation:ringPulse 1.5s ease-in-out infinite;}
@keyframes ringPulse{0%,100%{box-shadow:0 0 0 0 rgba(201,168,76,0.4);}50%{box-shadow:0 0 0 18px rgba(201,168,76,0);}}
.nfc-ring svg{width:44px;height:44px;color:var(--gold);position:relative;z-index:1;}
.nfc-waves{position:absolute;inset:-2px;border-radius:50%;pointer-events:none;}
.nfc-waves span{position:absolute;inset:0;border-radius:50%;border:1.5px solid rgba(201,168,76,0.28);animation:ripple 2s linear infinite;}
.nfc-waves span:nth-child(2){animation-delay:.55s;}.nfc-waves span:nth-child(3){animation-delay:1.1s;}
@keyframes ripple{0%{transform:scale(1);opacity:1;}100%{transform:scale(2.6);opacity:0;}}
.lbl{font-family:'Cinzel Decorative',serif;font-size:0.75rem;color:var(--gold);letter-spacing:2px;margin-bottom:5px;}
.status{font-size:0.7rem;color:rgba(245,240,232,0.45);margin-bottom:18px;min-height:18px;transition:color .25s;}
.status.ok{color:#2ecc71;}.status.err{color:#e74c3c;}

/* BUTTONS */
.btn-g{background:linear-gradient(135deg,var(--gold-d),var(--gold),var(--gold-d));color:var(--bg);border:none;padding:13px 24px;font-family:'Space Mono',monospace;font-size:0.76rem;font-weight:700;letter-spacing:2px;border-radius:10px;cursor:pointer;width:100%;text-transform:uppercase;transition:all .18s;box-shadow:0 4px 18px rgba(201,168,76,0.28);}
.btn-g:active{transform:scale(0.97);}
.btn-o{background:transparent;color:var(--gold);border:1px solid rgba(201,168,76,0.38);padding:11px 20px;font-family:'Space Mono',monospace;font-size:0.7rem;letter-spacing:1px;border-radius:10px;cursor:pointer;margin-top:9px;width:100%;transition:all .18s;}
.btn-o:active{background:rgba(201,168,76,0.09);}
.btn-d{background:rgba(192,57,43,0.12);color:#e74c3c;border:1px solid rgba(192,57,43,0.38);padding:11px 20px;font-family:'Space Mono',monospace;font-size:0.7rem;letter-spacing:1px;border-radius:10px;cursor:pointer;width:100%;transition:all .18s;margin-top:9px;}
.btn-d:active{background:rgba(192,57,43,0.25);}
.demo-note{font-size:0.58rem;color:rgba(245,240,232,0.22);margin-top:13px;line-height:1.6;}

/* NFC TAP BUTTON (shared) */
.nfc-btn{display:flex;align-items:center;justify-content:center;gap:9px;background:linear-gradient(135deg,var(--gold-d),var(--gold),var(--gold-d));color:var(--bg);border:none;padding:15px;border-radius:12px;font-family:'Space Mono',monospace;font-size:0.76rem;font-weight:700;letter-spacing:1px;cursor:pointer;box-shadow:0 4px 18px rgba(201,168,76,0.28);transition:all .18s;width:100%;max-width:420px;margin-bottom:9px;}
.nfc-btn:active{transform:scale(0.98);}
.nfc-btn.scanning{animation:btnPulse 1s ease-in-out infinite;}
.nfc-btn.wrong{background:linear-gradient(135deg,#922b21,#c0392b,#922b21)!important;animation:none;}
@keyframes btnPulse{0%,100%{box-shadow:0 4px 18px rgba(201,168,76,0.28);}50%{box-shadow:0 4px 36px rgba(201,168,76,0.75);}}

/* MODAL */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,0.88);display:flex;align-items:center;justify-content:center;z-index:600;opacity:0;pointer-events:none;transition:opacity .22s;}
.overlay.show{opacity:1;pointer-events:all;}
.mbox{background:linear-gradient(160deg,#0d2a15,#080f0a);border:1px solid rgba(201,168,76,0.32);border-radius:20px;padding:34px 26px;width:90%;max-width:315px;text-align:center;transform:scale(0.86);transition:transform .22s;box-shadow:0 20px 60px rgba(0,0,0,0.8);}
.overlay.show .mbox{transform:scale(1);}
.m-title{font-family:'Cinzel Decorative',serif;font-size:0.95rem;color:var(--gold);margin-bottom:5px;letter-spacing:1px;}
.m-sub{font-size:0.62rem;color:rgba(245,240,232,0.38);margin-bottom:18px;line-height:1.65;}
.m-input{width:100%;background:rgba(0,0,0,0.38);border:1px solid rgba(201,168,76,0.28);color:var(--white);padding:12px 14px;border-radius:10px;font-family:'Space Mono',monospace;font-size:0.88rem;outline:none;margin-bottom:12px;text-align:center;}
.m-input:focus{border-color:var(--gold);}
.m-cardid{font-size:0.55rem;color:rgba(245,240,232,0.22);margin-bottom:16px;word-break:break-all;}

/* ‚îÄ‚îÄ‚îÄ TOPBAR ‚îÄ‚îÄ‚îÄ */
.topbar{display:flex;justify-content:space-between;align-items:center;width:100%;max-width:430px;margin-bottom:16px;gap:7px;}
.user-pill{display:flex;align-items:center;gap:9px;background:rgba(201,168,76,0.07);border:1px solid rgba(201,168,76,0.18);border-radius:30px;padding:7px 14px;flex:1;min-width:0;}
.av{width:30px;height:30px;border-radius:50%;background:linear-gradient(135deg,var(--gold-d),var(--gold));display:flex;align-items:center;justify-content:center;font-size:0.72rem;color:var(--bg);font-weight:700;flex-shrink:0;}
.u-name{font-size:0.7rem;color:var(--gold);font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.u-id{font-size:0.52rem;color:rgba(245,240,232,0.28);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.ib{background:rgba(0,0,0,0.32);border:1px solid rgba(201,168,76,0.18);color:var(--gold);padding:7px 11px;border-radius:9px;font-size:0.68rem;cursor:pointer;white-space:nowrap;font-family:'Space Mono',monospace;transition:all .18s;}
.ib:active{background:rgba(201,168,76,0.09);}

/* ‚îÄ‚îÄ‚îÄ GREET BAR ‚îÄ‚îÄ‚îÄ */
.greet{width:100%;max-width:430px;background:rgba(201,168,76,0.055);border:1px solid rgba(201,168,76,0.13);border-radius:11px;padding:9px 14px;margin-bottom:16px;text-align:center;}
.greet-txt{font-family:'Playfair Display',serif;font-style:italic;color:var(--gold-l);font-size:0.82rem;}

/* ‚îÄ‚îÄ‚îÄ BALANCE ‚îÄ‚îÄ‚îÄ */
.bal-wrap{text-align:center;margin-bottom:20px;}
.bal-lbl{font-size:0.58rem;letter-spacing:3px;color:rgba(245,240,232,0.32);text-transform:uppercase;margin-bottom:3px;}
.bal-num{font-family:'Cinzel Decorative',serif;font-size:clamp(2rem,11vw,3.5rem);color:var(--gold);text-shadow:0 0 28px rgba(201,168,76,0.38);}

/* ‚îÄ‚îÄ‚îÄ LOAD FORM ‚îÄ‚îÄ‚îÄ */
.sec-title{font-family:'Cinzel Decorative',serif;font-size:0.82rem;color:var(--gold);margin-bottom:12px;letter-spacing:2px;text-align:center;}
.amt-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;width:100%;max-width:430px;margin-bottom:11px;}
.amt-btn{background:rgba(26,92,42,0.22);border:1px solid rgba(201,168,76,0.18);color:var(--white);padding:13px 5px;border-radius:10px;font-family:'Space Mono',monospace;font-size:0.8rem;font-weight:700;cursor:pointer;transition:all .18s;text-align:center;}
.amt-btn.sel,.amt-btn:active{background:rgba(201,168,76,0.16);border-color:var(--gold);color:var(--gold);box-shadow:var(--glow);}
.cust-wrap{width:100%;max-width:430px;position:relative;margin-bottom:10px;}
.cust-wrap span{position:absolute;left:13px;top:50%;transform:translateY(-50%);color:var(--gold);}
.cust-in{width:100%;background:rgba(0,0,0,0.28);border:1px solid rgba(201,168,76,0.18);color:var(--white);padding:12px 13px 12px 30px;border-radius:10px;font-family:'Space Mono',monospace;font-size:0.9rem;outline:none;}
.cust-in:focus{border-color:var(--gold);}
.max-note{font-size:0.58rem;color:rgba(245,240,232,0.22);text-align:center;margin-bottom:9px;}
.play-wrap{width:100%;max-width:430px;margin-top:4px;}

/* ‚îÄ‚îÄ‚îÄ GAME SCREEN ‚îÄ‚îÄ‚îÄ */
#gameScreen{padding:9px;justify-content:flex-start;background:var(--felt);background-image:radial-gradient(ellipse at top,rgba(45,138,66,0.22) 0%,transparent 48%);}
.game-top{display:flex;justify-content:space-between;align-items:center;width:100%;max-width:490px;margin-bottom:7px;padding:0 2px;}
.g-bal{font-family:'Cinzel Decorative',serif;font-size:1.12rem;color:var(--gold);text-shadow:0 0 14px rgba(201,168,76,0.45);line-height:1.1;}
.g-bal small{font-size:0.52rem;display:block;color:rgba(201,168,76,0.5);letter-spacing:2px;font-family:'Space Mono',monospace;}
.g-btns{display:flex;gap:5px;}

/* Wheel */
.whl-wrap{position:relative;width:min(252px,70vw);height:min(252px,70vw);margin:0 auto 7px;}
#whlCanvas{width:100%;height:100%;border-radius:50%;box-shadow:0 0 38px rgba(0,0,0,0.82),0 0 0 4px var(--gold-d),0 0 0 8px rgba(201,168,76,0.13);}
.whl-pointer{position:absolute;top:-7px;left:50%;transform:translateX(-50%);width:0;height:0;border-left:7px solid transparent;border-right:7px solid transparent;border-top:18px solid var(--gold);z-index:10;filter:drop-shadow(0 2px 3px rgba(0,0,0,0.5));}
.whl-num{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-family:'Cinzel Decorative',serif;font-size:2rem;font-weight:900;color:var(--gold);text-shadow:0 0 18px rgba(0,0,0,0.9),0 0 35px rgba(201,168,76,0.55);opacity:0;transition:opacity .35s;pointer-events:none;z-index:10;}
.whl-num.show{opacity:1;}

/* Bet section */
.bet-sec{width:100%;max-width:490px;margin:0 auto;}
.bet-lbl{font-size:0.56rem;letter-spacing:3px;color:rgba(245,240,232,0.32);text-align:center;margin-bottom:5px;text-transform:uppercase;}
.chip-row{display:flex;gap:6px;justify-content:center;margin-bottom:7px;flex-wrap:wrap;}
.chip{width:48px;height:48px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-family:'Space Mono',monospace;font-size:0.62rem;font-weight:700;cursor:pointer;transition:all .15s;border:3px solid rgba(255,255,255,0.22);position:relative;box-shadow:0 4px 9px rgba(0,0,0,0.38);user-select:none;}
.chip::after{content:'';position:absolute;inset:4px;border-radius:50%;border:1px dashed rgba(255,255,255,0.22);}
.chip:active,.chip.active{transform:scale(1.18) translateY(-3px);box-shadow:0 8px 18px rgba(0,0,0,0.5);border-color:rgba(255,255,255,0.55);}
.c5  {background:radial-gradient(circle at 35% 35%,#e74c3c,#922b21);color:#fff;}
.c25 {background:radial-gradient(circle at 35% 35%,#27ae60,#1a7040);color:#fff;}
.c50 {background:radial-gradient(circle at 35% 35%,#2980b9,#1a5c8a);color:#fff;}
.c100{background:radial-gradient(circle at 35% 35%,#8e44ad,#5b2c6f);color:#fff;}
.c500{background:radial-gradient(circle at 35% 35%,#c9a84c,#7a5c1e);color:#1a1a1a;}

/* Grid */
.num-grid{display:grid;grid-template-columns:repeat(12,1fr);gap:2px;margin-bottom:2px;}
.rn{aspect-ratio:1;border-radius:4px;display:flex;align-items:center;justify-content:center;font-size:clamp(0.48rem,1.8vw,0.7rem);font-weight:700;cursor:pointer;transition:all .1s;border:1px solid rgba(255,255,255,0.07);position:relative;user-select:none;overflow:hidden;}
.rn.rn-r{background:rgba(192,57,43,0.72);}
.rn.rn-b{background:rgba(18,18,18,0.92);}
.rn.rn-g{background:rgba(26,92,42,0.95);}
.rn:active{opacity:0.68;}
.rn.winner{animation:wFlash .38s ease 5;border-color:var(--gold)!important;z-index:2;}
@keyframes wFlash{0%,100%{background:rgba(201,168,76,0.82);}50%{}}

/* Chip overlay on cell */
.cc{position:absolute;inset:1px;border-radius:3px;display:flex;align-items:center;justify-content:center;font-size:clamp(0.36rem,1.3vw,0.55rem);font-weight:700;pointer-events:none;border:1.5px dashed rgba(255,255,255,0.28);z-index:3;}
.cc::after{content:'';position:absolute;inset:2px;border-radius:2px;border:1px dashed rgba(255,255,255,0.18);}

/* Outside bets */
.g3{display:grid;grid-template-columns:repeat(3,1fr);gap:2px;margin-bottom:2px;}
.g6{display:grid;grid-template-columns:repeat(3,1fr);gap:2px;margin-bottom:7px;}
.ob{padding:7px 3px;border-radius:4px;border:1px solid rgba(201,168,76,0.18);background:rgba(0,0,0,0.26);color:var(--white);font-family:'Space Mono',monospace;font-size:clamp(0.5rem,1.7vw,0.65rem);text-align:center;cursor:pointer;transition:all .1s;user-select:none;position:relative;overflow:hidden;}
.ob:active{opacity:0.68;}
.ob.sel{border-color:rgba(201,168,76,0.55);}
.ob.ob-r{background:rgba(192,57,43,0.48);}
.ob.ob-b{background:rgba(18,18,18,0.85);}
.ob .cc{inset:2px;}

/* Bet summary */
.bet-sum{background:rgba(0,0,0,0.26);border:1px solid rgba(201,168,76,0.1);border-radius:10px;padding:7px 11px;margin-bottom:7px;min-height:42px;}
.br{display:flex;justify-content:space-between;align-items:center;margin-bottom:2px;}
.bi{font-size:0.6rem;color:rgba(245,240,232,0.5);}
.ba{font-size:0.7rem;color:var(--gold);font-weight:700;}
.btr{display:flex;justify-content:space-between;border-top:1px solid rgba(201,168,76,0.1);padding-top:4px;margin-top:3px;}
.btl{font-size:0.52rem;letter-spacing:2px;color:rgba(245,240,232,0.32);}
.bta{font-size:0.78rem;color:var(--gold);font-weight:700;}
.nb{font-size:0.58rem;color:rgba(245,240,232,0.22);text-align:center;padding:4px 0;}

/* Spin controls */
.spin-row{display:flex;gap:7px;align-items:center;}
.clr-btn{flex:0 0 auto;background:rgba(192,57,43,0.16);border:1px solid rgba(192,57,43,0.38);color:#e74c3c;padding:13px 15px;border-radius:10px;font-size:0.88rem;cursor:pointer;}
.spin-btn{flex:1;display:flex;align-items:center;justify-content:center;gap:7px;background:linear-gradient(135deg,var(--gold-d),var(--gold),var(--gold-d));color:var(--bg);border:none;padding:13px;border-radius:10px;font-family:'Space Mono',monospace;font-size:0.7rem;font-weight:700;letter-spacing:1px;cursor:pointer;box-shadow:0 4px 18px rgba(201,168,76,0.28);transition:all .18s;text-transform:uppercase;}
.spin-btn:disabled{opacity:0.42;cursor:not-allowed;}
.spin-btn.scanning{animation:btnPulse 1s ease-in-out infinite;}
.spin-btn.wrong{background:linear-gradient(135deg,#922b21,#c0392b,#922b21)!important;animation:none;}

/* Result modal */
.res-modal{position:fixed;inset:0;background:rgba(0,0,0,0.88);display:flex;align-items:center;justify-content:center;z-index:400;opacity:0;pointer-events:none;transition:opacity .28s;}
.res-modal.show{opacity:1;pointer-events:all;}
.res-card{background:linear-gradient(135deg,#0d2a15,#080f0a);border:1px solid rgba(201,168,76,0.38);border-radius:20px;padding:34px 26px;text-align:center;max-width:290px;width:90%;transform:scale(0.84);transition:transform .28s;box-shadow:0 20px 55px rgba(0,0,0,0.82);}
.res-modal.show .res-card{transform:scale(1);}
.rn-big{font-family:'Cinzel Decorative',serif;font-size:4.2rem;font-weight:900;line-height:1;margin-bottom:5px;}
.rn-big.red  {color:#e74c3c;text-shadow:0 0 28px rgba(231,76,60,0.45);}
.rn-big.black{color:var(--white);text-shadow:0 0 28px rgba(255,255,255,0.18);}
.rn-big.green{color:var(--green-l);text-shadow:0 0 28px rgba(45,138,66,0.45);}
.r-out{font-family:'Cinzel Decorative',serif;font-size:1.32rem;margin-bottom:3px;}
.r-out.win{color:var(--gold);}.r-out.lose{color:#e74c3c;}
.r-pay{font-size:0.76rem;color:rgba(245,240,232,0.5);margin-bottom:18px;}
.r-pay.win{color:var(--gold-l);}

/* Settings */
.s-card{background:linear-gradient(135deg,rgba(26,92,42,0.16),rgba(8,15,10,0.82));border:1px solid rgba(201,168,76,0.18);border-radius:15px;padding:20px 18px;width:100%;max-width:430px;margin-bottom:12px;}
.s-title{font-family:'Cinzel Decorative',serif;font-size:0.7rem;color:var(--gold);letter-spacing:2px;margin-bottom:14px;}
.ir{display:flex;justify-content:space-between;margin-bottom:7px;}
.ik{font-size:0.6rem;color:rgba(245,240,232,0.38);}.iv{font-size:0.6rem;color:var(--gold);word-break:break-all;text-align:right;max-width:58%;}
.s-row{display:flex;align-items:center;gap:9px;}
.s-in{flex:1;background:rgba(0,0,0,0.32);border:1px solid rgba(201,168,76,0.18);color:var(--white);padding:10px 12px;border-radius:8px;font-family:'Space Mono',monospace;font-size:0.8rem;outline:none;}
.s-in:focus{border-color:var(--gold);}
.s-save{background:rgba(201,168,76,0.13);border:1px solid rgba(201,168,76,0.38);color:var(--gold);padding:10px 14px;border-radius:8px;font-family:'Space Mono',monospace;font-size:0.65rem;cursor:pointer;white-space:nowrap;}

/* Toast */
.toast{position:fixed;bottom:18px;left:50%;transform:translateX(-50%) translateY(75px);background:rgba(0,0,0,0.92);border:1px solid rgba(201,168,76,0.28);color:var(--gold);padding:10px 20px;border-radius:28px;font-size:0.7rem;letter-spacing:1px;transition:transform .28s;z-index:999;white-space:nowrap;max-width:88vw;text-align:center;}
.toast.show{transform:translateX(-50%) translateY(0);}
.toast.err{border-color:rgba(192,57,43,0.48);color:#e74c3c;}

/* NFC mini icon */
.ni{width:17px;height:17px;display:inline-block;vertical-align:middle;flex-shrink:0;}
</style>
</head>
<body>

<!-- ‚ïê‚ïê LOGIN ‚ïê‚ïê -->
<div id="loginScreen" class="screen active">
  <div class="casino-title">NFC<br>ROULETTE</div>
  <div class="casino-sub">Tap. Bet. Win.</div>
  <div class="nfc-card">
    <div class="nfc-ring" id="loginRing">
      <div class="nfc-waves"><span></span><span></span><span></span></div>
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z"/>
        <path d="M8.5 12a3.5 3.5 0 0 1 7 0"/><path d="M10.5 12a1.5 1.5 0 0 1 3 0"/><circle cx="12" cy="12" r="1"/>
      </svg>
    </div>
    <div class="lbl">NFC LOGIN</div>
    <div class="status" id="loginStatus">Tap your NFC card to continue</div>
    <button class="btn-g" onclick="startLogin()">üì° TAP NFC CARD</button>
    <button class="btn-o" onclick="demoLogin()">Demo (No NFC)</button>
    <div class="demo-note">Android Chrome + NFC required.<br>Demo mode works without hardware.</div>
  </div>
</div>

<!-- ‚ïê‚ïê NAME MODAL ‚ïê‚ïê -->
<div class="overlay" id="nameModal">
  <div class="mbox">
    <div class="m-title">NEW CARD DETECTED</div>
    <div class="m-sub">First time! Enter your name to register this NFC card to your account.</div>
    <div class="m-cardid" id="newCardDisplay"></div>
    <input class="m-input" id="newNameIn" type="text" placeholder="Your name" maxlength="20" autocomplete="off" onkeydown="if(event.key==='Enter')saveNewCard()">
    <button class="btn-g" onclick="saveNewCard()">REGISTER & ENTER</button>
  </div>
</div>

<!-- ‚ïê‚ïê CONFIRM MODAL ‚ïê‚ïê -->
<div class="overlay" id="confirmModal">
  <div class="mbox">
    <div class="m-title" id="confTitle">Are you sure?</div>
    <div class="m-sub" id="confSub">This cannot be undone.</div>
    <button class="btn-g" id="confYes" style="margin-bottom:8px">YES, CONFIRM</button>
    <button class="btn-o" onclick="closeConfirm()">Cancel</button>
  </div>
</div>

<!-- ‚ïê‚ïê LOAD SCREEN ‚ïê‚ïê -->
<div id="loadScreen" class="screen">
  <div class="topbar">
    <div class="user-pill">
      <div class="av" id="topAv">?</div>
      <div style="min-width:0">
        <div class="u-name" id="topName">Player</div>
        <div class="u-id" id="topId">‚Äî‚Äî</div>
      </div>
    </div>
    <button class="ib" onclick="showSettings()">‚öô</button>
    <button class="ib" onclick="logout()">‚Üê Logout</button>
  </div>

  <div class="greet" id="greetBar">
    <div class="greet-txt" id="greetTxt">Welcome!</div>
  </div>

  <div class="bal-wrap">
    <div class="bal-lbl">Balance</div>
    <div class="bal-num" id="loadBal">$0</div>
  </div>

  <div class="sec-title">LOAD CREDITS</div>
  <div class="amt-grid">
    <button class="amt-btn" onclick="pickAmt(100)">$100</button>
    <button class="amt-btn" onclick="pickAmt(500)">$500</button>
    <button class="amt-btn" onclick="pickAmt(1000)">$1,000</button>
    <button class="amt-btn" onclick="pickAmt(5000)">$5,000</button>
    <button class="amt-btn" onclick="pickAmt(10000)">$10,000</button>
    <button class="amt-btn" onclick="pickAmt(25000)">$25,000</button>
  </div>
  <div class="cust-wrap">
    <span>$</span>
    <input class="cust-in" id="custAmt" type="number" placeholder="Custom amount" min="1" max="100000" oninput="onCustIn()">
  </div>
  <div class="max-note">Max balance: $100,000</div>

  <button class="nfc-btn" id="loadBtn" onclick="startLoad()">
    <svg class="ni" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10"/><path d="M12 6c3.31 0 6 2.69 6 6"/>
      <path d="M12 10c1.1 0 2 .9 2 2"/><circle cx="12" cy="12" r="1"/>
    </svg>
    TAP SAME NFC TO LOAD
  </button>
  <div class="play-wrap">
    <button class="btn-g" onclick="goGame()">‚ñ∂ PLAY ROULETTE</button>
    <button class="btn-o" id="checkoutBtn" onclick="downloadReceipt()" style="margin-top:9px;display:flex;align-items:center;justify-content:center;gap:8px;">
      <svg style="width:15px;height:15px;flex-shrink:0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
      CHECKOUT & DOWNLOAD RECEIPT
    </button>
  </div>
</div>

<!-- ‚ïê‚ïê GAME SCREEN ‚ïê‚ïê -->
<div id="gameScreen" class="screen">
  <div class="game-top">
    <div class="g-bal"><small>BALANCE</small>$<span id="gameBal">0</span></div>
    <div class="g-btns">
      <button class="ib" onclick="goLoad()">‚Üê Back</button>
      <button class="ib" onclick="goLoad()">+ Credits</button>
    </div>
  </div>

  <div class="whl-wrap">
    <canvas id="whlCanvas" width="400" height="400"></canvas>
    <div class="whl-pointer"></div>
    <div class="whl-num" id="whlNum"></div>
  </div>

  <div class="bet-sec">
    <div class="bet-lbl">Select chip value</div>
    <div class="chip-row">
      <div class="chip c5   active" onclick="pickChip(5,this)">$5</div>
      <div class="chip c25"        onclick="pickChip(25,this)">$25</div>
      <div class="chip c50"        onclick="pickChip(50,this)">$50</div>
      <div class="chip c100"       onclick="pickChip(100,this)">$100</div>
      <div class="chip c500"       onclick="pickChip(500,this)">$500</div>
    </div>

    <div id="zeroRow" style="margin-bottom:2px"></div>
    <div class="num-grid" id="numGrid"></div>
    <div class="g3" id="dozens"></div>
    <div class="g3" id="cols"></div>
    <div class="g6" id="outside"></div>

    <div class="bet-sum" id="betSum"><div class="nb">No bets placed yet</div></div>

    <div class="spin-row">
      <button class="clr-btn" onclick="clearBets()">‚úï</button>
      <button class="spin-btn" id="spinBtn" onclick="startSpin()">
        <svg class="ni" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10"/><path d="M12 6c3.31 0 6 2.69 6 6"/>
          <circle cx="12" cy="12" r="1"/>
        </svg>
        TAP NFC TO SPIN
      </button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê SETTINGS SCREEN ‚ïê‚ïê -->
<div id="settingsScreen" class="screen">
  <div class="topbar">
    <div style="font-family:'Cinzel Decorative',serif;font-size:0.85rem;color:var(--gold);letter-spacing:2px;">SETTINGS</div>
    <button class="ib" onclick="backSettings()">‚Üê Back</button>
  </div>

  <div class="s-card">
    <div class="s-title">CARD INFO</div>
    <div class="ir"><span class="ik">Card ID</span><span class="iv" id="sCardId">‚Äî</span></div>
    <div class="ir"><span class="ik">Name</span><span class="iv" id="sName">‚Äî</span></div>
    <div class="ir"><span class="ik">Registered</span><span class="iv" id="sReg">‚Äî</span></div>
    <div class="ir"><span class="ik">Balance</span><span class="iv" id="sBal">‚Äî</span></div>
  </div>

  <div class="s-card">
    <div class="s-title">RENAME CARD</div>
    <div class="s-row">
      <input class="s-in" id="renameIn" type="text" placeholder="New name" maxlength="20" onkeydown="if(event.key==='Enter')doRename()">
      <button class="s-save" onclick="doRename()">SAVE</button>
    </div>
  </div>

  <div class="s-card">
    <div class="s-title">DANGER ZONE</div>
    <button class="btn-d" onclick="confirmReset()">‚ö† Reset Balance to $0</button>
    <button class="btn-d" onclick="confirmDelete()">üóë Delete Card & All Data</button>
  </div>
</div>

<!-- ‚ïê‚ïê RESULT MODAL ‚ïê‚ïê -->
<div class="res-modal" id="resModal">
  <div class="res-card">
    <div class="rn-big" id="resNum">0</div>
    <div class="r-out" id="resOut">‚Äî</div>
    <div class="r-pay" id="resPay">‚Äî</div>
    <button class="btn-g" onclick="closeResult()">CONTINUE</button>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONSTANTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const REDS = new Set([1,3,5,7,9,12,14,16,18,19,21,23,25,27,30,32,34,36]);
const WHEEL = [0,32,15,19,4,21,2,25,17,34,6,27,13,36,11,30,8,23,10,5,24,16,33,1,20,14,31,9,22,18,29,7,28,12,35,3,26];
const MAX_BAL = 100000;
const GREETINGS = ['Welcome back','Good to see you again','Hello','Great to have you back','Nice to see you'];
const CHIP_COLS = {
  5:   {a:'#e74c3c',b:'#922b21',t:'#fff'},
  25:  {a:'#27ae60',b:'#1a7040',t:'#fff'},
  50:  {a:'#2980b9',b:'#1a5c8a',t:'#fff'},
  100: {a:'#8e44ad',b:'#5b2c6f',t:'#fff'},
  500: {a:'#c9a84c',b:'#7a5c1e',t:'#1a1a1a'}
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const G = {
  cardId: null,
  name: '',
  balance: 0,
  chip: 5,
  bets: [],
  spinning: false,
  wheelRot: 0,
  pendingId: null,
  // Session tracking for receipt
  sessionStart: null,
  sessionStartBalance: 0,
  sessionLoaded: 0,
  rounds: []   // [{round, bets:[{label,amount}], result, resultColor, totalBet, totalWin, net, balanceAfter}]
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STORAGE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const key = id => 'nfc_v2_' + id;
const loadData = id => { try{ return JSON.parse(localStorage.getItem(key(id))); }catch(e){return null;} };
const saveData = d => localStorage.setItem(key(d.id), JSON.stringify(d));
const delData  = id => localStorage.removeItem(key(id));

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NFC
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let nfcAbort = null;

async function nfcScan(onId) {
  stopNfc();
  if (!('NDEFReader' in window)) {
    // Demo fallback:
    // - If already logged in, echo back the current card so load/spin checks pass
    // - If not logged in (login screen), generate a fresh ID each time so name is always asked
    setTimeout(() => onId(G.cardId ? G.cardId : 'DEMO-' + Math.random().toString(36).substr(2,5).toUpperCase()), 600);
    return;
  }
  nfcAbort = new AbortController();
  try {
    const ndef = new NDEFReader();
    await ndef.scan({ signal: nfcAbort.signal });
    ndef.addEventListener('reading', e => {
      const raw = e.serialNumber || 'CARD-' + Math.random().toString(36).substr(2,8);
      onId(raw.toUpperCase().replace(/:/g,''));
    }, { once: true });
  } catch(e) {
    if (e.name !== 'AbortError') {
      // Fallback: echo logged-in card or generate fresh one
      onId(G.cardId ? G.cardId : 'DEMO-' + Math.random().toString(36).substr(2,5).toUpperCase());
    }
  }
}

function stopNfc() {
  if (nfcAbort) { try{ nfcAbort.abort(); }catch(e){} nfcAbort = null; }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LOGIN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function startLogin() {
  const ring = document.getElementById('loginRing');
  const st = document.getElementById('loginStatus');
  ring.classList.add('pulse');
  st.textContent = 'Hold NFC card near phone‚Ä¶';
  st.className = 'status';

  nfcScan(id => {
    ring.classList.remove('pulse');
    handleCard(id);
  });
}

function handleCard(id) {
  const data = loadData(id);
  if (data) {
    enterGame(data, false);
  } else {
    G.pendingId = id;
    document.getElementById('newCardDisplay').textContent = 'Card ID: ' + id;
    document.getElementById('newNameIn').value = '';
    showOverlay('nameModal');
    setTimeout(() => document.getElementById('newNameIn').focus(), 320);
  }
}

function saveNewCard() {
  const name = document.getElementById('newNameIn').value.trim();
  if (!name) { toast('Enter your name first'); return; }
  const data = { id: G.pendingId, name, balance: 0, registered: new Date().toLocaleDateString('en-GB') };
  saveData(data);
  hideOverlay('nameModal');
  enterGame(data, true);
}

function enterGame(data, isNew) {
  G.cardId  = data.id;
  G.name    = data.name;
  G.balance = data.balance || 0;
  stopNfc();
  // Reset session tracking
  G.sessionStart        = new Date();
  G.sessionStartBalance = G.balance;
  G.sessionLoaded       = 0;
  G.rounds              = [];
  refreshTopbar();
  updateBal();
  const g = isNew
    ? 'Welcome to NFC Roulette, ' + G.name + '! üé∞'
    : GREETINGS[Math.floor(Math.random()*GREETINGS.length)] + ', ' + G.name + '! üé≤';
  document.getElementById('greetTxt').textContent = g;
  setStatus('Tap your NFC card to continue', '');
  showScreen('loadScreen');
}

function demoLogin() {
  stopNfc();
  // Always generate a fresh demo ID so name is asked every time
  const id = 'DEMO-' + Math.random().toString(36).substr(2,5).toUpperCase();
  handleCard(id);
}

function logout() {
  stopNfc();
  G.cardId = null; G.name = ''; G.balance = 0; G.bets = [];
  showScreen('loginScreen');
}

function setStatus(msg, cls) {
  const el = document.getElementById('loginStatus');
  el.textContent = msg; el.className = 'status' + (cls ? ' '+cls : '');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LOAD MONEY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let chosenAmt = 0;

function pickAmt(n) {
  chosenAmt = n;
  document.getElementById('custAmt').value = '';
  document.querySelectorAll('.amt-btn').forEach(b => {
    b.classList.toggle('sel', parseInt(b.textContent.replace(/[^0-9]/g,''))===n);
  });
}

function onCustIn() {
  chosenAmt = 0;
  document.querySelectorAll('.amt-btn').forEach(b=>b.classList.remove('sel'));
}

function getAmt() {
  const c = parseInt(document.getElementById('custAmt').value);
  const amt = c || chosenAmt;
  if (!amt || amt<=0) return null;
  if (G.balance + amt > MAX_BAL) { toast('Max balance is $'+MAX_BAL.toLocaleString()); return null; }
  return amt;
}

function startLoad() {
  const amt = getAmt();
  if (!amt) { toast('Select an amount first'); return; }
  const btn = document.getElementById('loadBtn');
  setLoadBtn('scanning', 'üì° Scanning‚Ä¶');

  if (!('NDEFReader' in window)) {
    setTimeout(() => { doLoad(amt); resetLoadBtn(); }, 700);
    return;
  }

  let timedOut = false;
  const tmo = setTimeout(() => { timedOut=true; stopNfc(); resetLoadBtn(); toast('Scan timed out'); }, 18000);

  nfcScan(id => {
    clearTimeout(tmo);
    if (timedOut) return;
    if (id !== G.cardId) {
      setLoadBtn('wrong', '‚ö† Wrong Card!');
      setTimeout(resetLoadBtn, 2200);
      toast('Use the same card you logged in with!', true);
    } else {
      doLoad(amt);
      resetLoadBtn();
    }
  });
}

function doLoad(amt) {
  G.balance = Math.min(MAX_BAL, G.balance + amt);
  G.sessionLoaded += amt;
  persist();
  updateBal();
  toast('‚úì Loaded $' + amt.toLocaleString());
  chosenAmt = 0;
  document.querySelectorAll('.amt-btn').forEach(b=>b.classList.remove('sel'));
  document.getElementById('custAmt').value = '';
}

function setLoadBtn(state, txt) {
  const b = document.getElementById('loadBtn');
  b.className = 'nfc-btn' + (state ? ' '+state : '');
  b.innerHTML = txt || `<svg class="ni" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10"/><path d="M12 6c3.31 0 6 2.69 6 6"/><path d="M12 10c1.1 0 2 .9 2 2"/><circle cx="12" cy="12" r="1"/></svg> TAP SAME NFC TO LOAD`;
}

function resetLoadBtn() { setLoadBtn('', ''); }

function persist() {
  const data = loadData(G.cardId) || { id:G.cardId, name:G.name, registered:new Date().toLocaleDateString('en-GB') };
  data.balance = G.balance;
  saveData(data);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NAVIGATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

function showOverlay(id) { document.getElementById(id).classList.add('show'); }
function hideOverlay(id) { document.getElementById(id).classList.remove('show'); }

function goGame() {
  if (G.balance <= 0) { toast('Load credits first!'); return; }
  clearBets();
  updateBal();
  showScreen('gameScreen');
}

function goLoad() { stopNfc(); showScreen('loadScreen'); updateBal(); }

function showSettings() {
  const d = loadData(G.cardId) || {};
  document.getElementById('sCardId').textContent  = G.cardId;
  document.getElementById('sName').textContent    = G.name;
  document.getElementById('sReg').textContent     = d.registered || '‚Äî';
  document.getElementById('sBal').textContent     = '$' + G.balance.toLocaleString();
  document.getElementById('renameIn').value       = G.name;
  showScreen('settingsScreen');
}

function backSettings() { showScreen('loadScreen'); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BALANCE & UI
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateBal() {
  document.getElementById('loadBal').textContent = '$' + G.balance.toLocaleString();
  document.getElementById('gameBal').textContent = G.balance.toLocaleString();
}

function refreshTopbar() {
  document.getElementById('topAv').textContent   = G.name.charAt(0).toUpperCase();
  document.getElementById('topName').textContent = G.name;
  document.getElementById('topId').textContent   = G.cardId.length > 14 ? G.cardId.substr(0,14)+'‚Ä¶' : G.cardId;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SETTINGS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function doRename() {
  const n = document.getElementById('renameIn').value.trim();
  if (!n) { toast('Enter a name'); return; }
  G.name = n;
  const d = loadData(G.cardId) || { id:G.cardId, balance:G.balance, registered:new Date().toLocaleDateString('en-GB') };
  d.name = n; saveData(d);
  refreshTopbar();
  document.getElementById('sName').textContent = n;
  toast('Name updated to ' + n + ' ‚úì');
}

function confirmReset() {
  openConfirm('Reset Balance?','This will set your balance to $0.',()=>{
    G.balance = 0; persist(); updateBal();
    document.getElementById('sBal').textContent = '$0';
    toast('Balance reset to $0');
  });
}

function confirmDelete() {
  openConfirm('Delete Card?','All data for this card will be permanently deleted.',()=>{
    delData(G.cardId); logout(); toast('Card deleted');
  });
}

function openConfirm(title, sub, fn) {
  document.getElementById('confTitle').textContent = title;
  document.getElementById('confSub').textContent = sub;
  document.getElementById('confYes').onclick = ()=>{ closeConfirm(); fn(); };
  showOverlay('confirmModal');
}

function closeConfirm() { hideOverlay('confirmModal'); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// WHEEL DRAW
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function drawWheel(rot) {
  const c = document.getElementById('whlCanvas');
  const ctx = c.getContext('2d');
  const cx=200, cy=200, ir=168, or=198;
  ctx.clearRect(0,0,400,400);

  // Outer ring
  const og = ctx.createRadialGradient(cx,cy,ir,cx,cy,or);
  og.addColorStop(0,'#3a2a08'); og.addColorStop(.5,'#c9a84c'); og.addColorStop(1,'#3a2a08');
  ctx.beginPath(); ctx.arc(cx,cy,or,0,Math.PI*2); ctx.fillStyle=og; ctx.fill();

  const n = WHEEL.length, sl = Math.PI*2/n;
  WHEEL.forEach((num,i)=>{
    const a0=rot+i*sl, a1=a0+sl;
    const col = num===0?'#1a6b30':REDS.has(num)?'#c0392b':'#161616';
    ctx.beginPath(); ctx.moveTo(cx,cy); ctx.arc(cx,cy,ir,a0,a1); ctx.closePath();
    ctx.fillStyle=col; ctx.fill();
    ctx.strokeStyle='rgba(201,168,76,0.22)'; ctx.lineWidth=0.7; ctx.stroke();

    const mid=a0+sl/2, tx=cx+142*Math.cos(mid), ty=cy+142*Math.sin(mid);
    ctx.save(); ctx.translate(tx,ty); ctx.rotate(mid+Math.PI/2);
    ctx.fillStyle='#fff'; ctx.font='bold 12px "Space Mono",monospace';
    ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.shadowColor='rgba(0,0,0,0.85)'; ctx.shadowBlur=4;
    ctx.fillText(num,0,0); ctx.restore();
  });

  // Hub
  const hg = ctx.createRadialGradient(cx,cy,0,cx,cy,34);
  hg.addColorStop(0,'#c9a84c'); hg.addColorStop(1,'#3a2a08');
  ctx.beginPath(); ctx.arc(cx,cy,34,0,Math.PI*2); ctx.fillStyle=hg; ctx.fill();
  ctx.beginPath(); ctx.arc(cx,cy,7,0,Math.PI*2); ctx.fillStyle='#0d0d0d'; ctx.fill();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BUILD GRID
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function nClass(n){ return n===0?'rn-g':REDS.has(n)?'rn-r':'rn-b'; }
function nColor(n){ return n===0?'green':REDS.has(n)?'red':'black'; }

function buildGrid() {
  // Zero
  const zr = document.getElementById('zeroRow');
  zr.innerHTML='';
  const z = mkCell('s-0','0','rn-g',true); zr.appendChild(z);

  // Numbers
  const ng = document.getElementById('numGrid'); ng.innerHTML='';
  [[3,6,9,12,15,18,21,24,27,30,33,36],
   [2,5,8,11,14,17,20,23,26,29,32,35],
   [1,4,7,10,13,16,19,22,25,28,31,34]].forEach(row=>
    row.forEach(n=>ng.appendChild(mkCell('s-'+n, n, nClass(n))))
  );

  // Dozens
  const dz=document.getElementById('dozens'); dz.innerHTML='';
  [['dz-1','1st 12'],['dz-2','2nd 12'],['dz-3','3rd 12']].forEach(([t,l])=>dz.appendChild(mkOB(t,l,'')));

  // Columns
  const cl=document.getElementById('cols'); cl.innerHTML='';
  [['co-1','Col 1'],['co-2','Col 2'],['co-3','Col 3']].forEach(([t,l])=>cl.appendChild(mkOB(t,l,'')));

  // Outside
  const ob=document.getElementById('outside'); ob.innerHTML='';
  [['lo','1‚Äì18',''],['ev','Even',''],['re','Red','ob-r'],['bl','Black','ob-b'],['od','Odd',''],['hi','19‚Äì36','']].forEach(([t,l,e])=>ob.appendChild(mkOB(t,l,e)));
}

function mkCell(type, label, cls, isZero=false) {
  const el=document.createElement('div');
  el.className='rn '+cls; el.dataset.t=type;
  if(isZero) el.style.cssText='grid-column:1/-1;aspect-ratio:unset;padding:5px 7px;font-size:0.76rem;margin-bottom:2px;';
  el.textContent=label;
  el.addEventListener('click',()=>placeBet(type,el,String(label)));
  return el;
}

function mkOB(type, label, extra) {
  const el=document.createElement('div');
  el.className='ob'+(extra?' '+extra:''); el.dataset.t=type;
  el.textContent=label;
  el.addEventListener('click',()=>placeBet(type,el,label));
  return el;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CHIP OVERLAY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function bestChip(amt) {
  for(const v of [500,100,50,25,5]){ if(amt>=v) return v; }
  return 5;
}

function chipHtml(amt) {
  const v = bestChip(amt);
  const c = CHIP_COLS[v];
  const lbl = amt>=1000 ? '$'+(amt/1000).toFixed(amt%1000===0?0:1)+'k' : '$'+amt;
  return `<div class="cc" style="background:radial-gradient(circle at 35% 35%,${c.a},${c.b});color:${c.t}">${lbl}</div>`;
}

function refreshChips() {
  document.querySelectorAll('.cc').forEach(e=>e.remove());
  document.querySelectorAll('[data-t].sel,.rn.sel').forEach(e=>e.classList.remove('sel'));
  G.bets.forEach(bet => {
    const el = document.querySelector('[data-t="'+bet.type+'"]');
    if (!el) return;
    el.classList.add('sel');
    el.insertAdjacentHTML('beforeend', chipHtml(bet.amount));
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BETTING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function pickChip(v, el) {
  G.chip = v;
  document.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
  el.classList.add('active');
}

function placeBet(type, el, label) {
  if (G.spinning) return;
  const soFar = G.bets.reduce((a,b)=>a+b.amount,0);
  if (soFar + G.chip > G.balance) { toast('Not enough balance!'); return; }
  const ex = G.bets.find(b=>b.type===type);
  if (ex) ex.amount += G.chip;
  else G.bets.push({ type, label:String(label), amount:G.chip });
  refreshChips();
  refreshBetSummary();
}

function clearBets() {
  G.bets=[];
  refreshChips();
  refreshBetSummary();
}

function refreshBetSummary() {
  const el = document.getElementById('betSum');
  if (!G.bets.length) { el.innerHTML='<div class="nb">No bets placed yet</div>'; return; }
  const total = G.bets.reduce((a,b)=>a+b.amount,0);
  el.innerHTML = G.bets.map(b=>
    `<div class="br"><span class="bi">${b.label}</span><span class="ba">$${b.amount.toLocaleString()}</span></div>`
  ).join('') +
  `<div class="btr"><span class="btl">TOTAL BET</span><span class="bta">$${total.toLocaleString()}</span></div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SPIN NFC
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function startSpin() {
  if (G.spinning) return;
  if (!G.bets.length) { toast('Place a bet first!'); return; }
  const total = G.bets.reduce((a,b)=>a+b.amount,0);
  if (total > G.balance) { toast('Insufficient balance!'); return; }

  if (!('NDEFReader' in window)) { doSpin(); return; }

  const btn = document.getElementById('spinBtn');
  btn.classList.add('scanning'); btn.disabled=true;
  btn.innerHTML='<svg class="ni" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10"/><circle cx="12" cy="12" r="1"/></svg> Tap NFC‚Ä¶';

  let tmo = setTimeout(()=>{ stopNfc(); resetSpinBtn(); }, 18000);

  nfcScan(id => {
    clearTimeout(tmo);
    if (id !== G.cardId) {
      btn.classList.remove('scanning'); btn.classList.add('wrong'); btn.disabled=false;
      btn.textContent='‚ö† Wrong Card!';
      setTimeout(resetSpinBtn, 2200);
      toast('Use the same card you logged in with!', true);
    } else {
      resetSpinBtn();
      doSpin();
    }
  });
}

function resetSpinBtn() {
  const btn = document.getElementById('spinBtn');
  btn.className='spin-btn'; btn.disabled=false;
  btn.innerHTML='<svg class="ni" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10"/><path d="M12 6c3.31 0 6 2.69 6 6"/><circle cx="12" cy="12" r="1"/></svg> TAP NFC TO SPIN';
}

function doSpin() {
  if (G.spinning) return;
  G.spinning = true;
  const total = G.bets.reduce((a,b)=>a+b.amount,0);
  const snap  = G.bets.map(b=>({...b}));
  G.balance -= total; updateBal();

  const btn = document.getElementById('spinBtn');
  btn.disabled=true; btn.textContent='Spinning‚Ä¶';

  const result = Math.floor(Math.random()*37);
  const idx    = WHEEL.indexOf(result);
  const sl     = Math.PI*2/WHEEL.length;
  // pointer is at top = rotation offset -PI/2
  const target = -Math.PI/2 - (idx*sl + sl/2);
  const spins  = (5+Math.random()*3)*Math.PI*2;
  // Compute how far from current rotation to target, going backwards (clockwise spin)
  let delta = (target - G.wheelRot) % (Math.PI*2);
  if (delta > 0) delta -= Math.PI*2;
  const endRot = G.wheelRot + delta - spins;

  const start = G.wheelRot;
  let t0=null; const dur=4200;

  (function frame(ts){
    if(!t0) t0=ts;
    const t=Math.min((ts-t0)/dur,1);
    const e=1-Math.pow(1-t,4);
    G.wheelRot = start+(endRot-start)*e;
    drawWheel(G.wheelRot);
    if(t<1){ requestAnimationFrame(frame); }
    else{
      G.wheelRot=endRot; drawWheel(endRot);
      showResult(result,total,snap);
    }
  })(performance.now());
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// WIN CALC
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function calcWin(result, bets) {
  let win=0; const col=nColor(result);
  bets.forEach(b=>{
    const t=b.type;
    if(t.startsWith('s-')){
      if(parseInt(t.slice(2))===result) win+=b.amount*35;
    } else if(t==='re'&&col==='red')   win+=b.amount;
    else if(t==='bl'&&col==='black')   win+=b.amount;
    else if(t==='ev'&&result!==0&&result%2===0) win+=b.amount;
    else if(t==='od'&&result%2===1)    win+=b.amount;
    else if(t==='lo'&&result>=1&&result<=18)  win+=b.amount;
    else if(t==='hi'&&result>=19&&result<=36) win+=b.amount;
    else if(t.startsWith('dz-')){
      const d=parseInt(t[3]);
      if((d===1&&result>=1&&result<=12)||(d===2&&result>=13&&result<=24)||(d===3&&result>=25&&result<=36))
        win+=b.amount*2;
    } else if(t.startsWith('co-')){
      const c=parseInt(t[3]);
      if(result!==0&&((result-1)%3)+1===c) win+=b.amount*2;
    }
  });
  return win;
}

function showResult(result, total, snap) {
  const win = calcWin(result, snap);
  G.balance += win;
  G.balance = Math.round(G.balance*100)/100;
  persist(); updateBal();

  // Record round for receipt
  G.rounds.push({
    round:        G.rounds.length + 1,
    bets:         snap.map(b => ({ label: b.label, amount: b.amount })),
    result:       result,
    resultColor:  nColor(result),
    totalBet:     total,
    totalWin:     win,
    net:          win - total,
    balanceAfter: G.balance
  });

  // Flash result on wheel
  const wn=document.getElementById('whlNum');
  wn.textContent=result; wn.classList.add('show');

  // Highlight number on grid
  document.querySelectorAll('[data-t="s-'+result+'"]').forEach(e=>e.classList.add('winner'));

  // Modal
  const col=nColor(result);
  document.getElementById('resNum').textContent=result;
  document.getElementById('resNum').className='rn-big '+col;

  if(win>0){
    document.getElementById('resOut').textContent='üéâ YOU WIN!';
    document.getElementById('resOut').className='r-out win';
    document.getElementById('resPay').textContent='+$'+win.toLocaleString()+' (net +$'+(win-total).toLocaleString()+')';
    document.getElementById('resPay').className='r-pay win';
  } else {
    document.getElementById('resOut').textContent='YOU LOSE';
    document.getElementById('resOut').className='r-out lose';
    document.getElementById('resPay').textContent='-$'+total.toLocaleString();
    document.getElementById('resPay').className='r-pay';
  }

  setTimeout(()=>document.getElementById('resModal').classList.add('show'), 380);
}

function closeResult() {
  document.getElementById('resModal').classList.remove('show');
  document.getElementById('whlNum').classList.remove('show');
  document.querySelectorAll('.rn.winner').forEach(e=>e.classList.remove('winner'));
  G.spinning=false;
  resetSpinBtn();
  clearBets();
  if(G.balance<=0){ toast('Out of credits! Load more.'); setTimeout(goLoad,1400); }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TOAST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let toastTmo;
function toast(msg, isErr=false) {
  const t=document.getElementById('toast');
  t.textContent=msg;
  t.className='toast show'+(isErr?' err':'');
  clearTimeout(toastTmo);
  toastTmo=setTimeout(()=>t.classList.remove('show'),2800);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RECEIPT PDF
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function downloadReceipt() {
  if (!G.cardId) { toast('Not logged in'); return; }
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit: 'mm', format: 'a4' });

  const W = 210, PL = 18, PR = 18, CW = W - PL - PR;
  let y = 0;

  // ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ
  const gold  = [201,168,76];
  const dark  = [8,15,10];
  const felt  = [13,61,26];
  const white = [245,240,232];
  const red   = [192,57,43];
  const grey  = [100,100,100];
  const lightGrey = [220,220,220];

  function rect(x,yy,w,h,r,g,b){ doc.setFillColor(r,g,b); doc.rect(x,yy,w,h,'F'); }
  function line(x1,y1,x2,y2,r,g,b,lw){
    doc.setDrawColor(r,g,b); doc.setLineWidth(lw||0.3); doc.line(x1,y1,x2,y2);
  }
  function txt(text,x,yy,size,r,g,b,align,style){
    doc.setFontSize(size); doc.setTextColor(r,g,b);
    doc.setFont('helvetica', style||'normal');
    doc.text(String(text), x, yy, { align: align||'left' });
  }
  function fmtAmt(n){ return (n>=0?'+':'')+' $'+Math.abs(n).toLocaleString(); }
  function fmtDate(d){ return d ? d.toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric'}) : '‚Äî'; }
  function fmtTime(d){ return d ? d.toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit',second:'2-digit'}) : '‚Äî'; }

  // ‚îÄ‚îÄ Page background ‚îÄ‚îÄ
  rect(0,0,210,297, ...dark);

  // ‚îÄ‚îÄ Header band ‚îÄ‚îÄ
  rect(0,0,210,52, ...felt);
  // Gold top border line
  rect(0,0,210,1.2, ...gold);

  // Decorative diagonal pattern (subtle)
  doc.setDrawColor(201,168,76); doc.setLineWidth(0.15); doc.setGState(new doc.GState({opacity:0.06}));
  for(let i=-50;i<260;i+=12){ doc.line(i,0,i+60,52); }
  doc.setGState(new doc.GState({opacity:1}));

  // Casino name
  txt('NFC ROULETTE', W/2, 20, 26, ...gold, 'center', 'bold');
  txt('OFFICIAL SESSION RECEIPT', W/2, 28, 9, ...white, 'center', 'normal');
  doc.setDrawColor(...gold); doc.setLineWidth(0.4);
  doc.line(PL+20, 31, W-PR-20, 31);
  // Receipt number
  const receiptNo = 'REC-' + Date.now().toString(36).toUpperCase();
  txt('Receipt No: ' + receiptNo, W/2, 38, 7, ...gold, 'center', 'normal');
  txt('Generated: ' + fmtDate(new Date()) + '  ' + fmtTime(new Date()), W/2, 44, 7, 180,160,100, 'center', 'normal');

  y = 60;

  // ‚îÄ‚îÄ Player Info Card ‚îÄ‚îÄ
  rect(PL, y, CW, 36, 20, 40, 25);
  doc.setDrawColor(...gold); doc.setLineWidth(0.35);
  doc.roundedRect(PL, y, CW, 36, 3, 3, 'S');

  // Avatar circle
  doc.setFillColor(...gold);
  doc.circle(PL+14, y+14, 8, 'F');
  txt(G.name.charAt(0).toUpperCase(), PL+14, y+17.5, 12, ...dark, 'center', 'bold');

  txt(G.name, PL+28, y+12, 13, ...gold, 'left', 'bold');
  txt('Card ID: ' + G.cardId, PL+28, y+19, 7.5, 180,160,100, 'left', 'normal');
  txt('Session: ' + fmtDate(G.sessionStart) + '  ' + fmtTime(G.sessionStart), PL+28, y+25.5, 7, ...grey, 'left', 'normal');
  txt('Checkout: ' + fmtDate(new Date()) + '  ' + fmtTime(new Date()), PL+28, y+31.5, 7, ...grey, 'left', 'normal');

  y += 44;

  // ‚îÄ‚îÄ Balance Summary ‚îÄ‚îÄ
  const totalLoaded = G.sessionLoaded;
  const openBal  = G.sessionStartBalance;
  const closeBal = G.balance;
  const netPL    = closeBal - openBal - totalLoaded;
  const totalWagered = G.rounds.reduce((a,r)=>a+r.totalBet,0);
  const totalWon     = G.rounds.reduce((a,r)=>a+r.totalWin,0);

  // Summary boxes (3 cols)
  const bw = (CW - 8) / 3;
  const boxes = [
    { lbl: 'OPENING BALANCE', val: '$' + openBal.toLocaleString(),  sub: 'at login',      col: gold },
    { lbl: 'TOTAL LOADED',    val: '$' + totalLoaded.toLocaleString(), sub: 'credits added', col: [80,180,120] },
    { lbl: 'CLOSING BALANCE', val: '$' + closeBal.toLocaleString(), sub: 'current',        col: gold }
  ];
  boxes.forEach((b,i)=>{
    const bx = PL + i*(bw+4);
    rect(bx, y, bw, 28, 20, 40, 25);
    doc.setDrawColor(...b.col); doc.setLineWidth(0.3);
    doc.roundedRect(bx, y, bw, 28, 2, 2, 'S');
    rect(bx, y, bw, 1.5, ...b.col); // coloured top accent
    txt(b.lbl, bx+bw/2, y+9, 6, ...grey, 'center', 'bold');
    txt(b.val, bx+bw/2, y+19, 11, ...white, 'center', 'bold');
    txt(b.sub, bx+bw/2, y+25, 5.5, ...grey, 'center', 'normal');
  });

  y += 35;

  // Net P&L banner
  const plPos = netPL >= 0;
  rect(PL, y, CW, 16, ...(plPos ? [20,55,30] : [55,20,20]));
  doc.setDrawColor(...(plPos ? [80,200,120] : [220,80,80])); doc.setLineWidth(0.4);
  doc.roundedRect(PL, y, CW, 16, 2, 2, 'S');
  txt('NET P&L THIS SESSION', PL+10, y+7, 7, ...(plPos ? [180,240,180] : [240,180,180]), 'left', 'bold');
  txt((plPos?'‚ñ≤ +':' ‚ñº -') + ' $' + Math.abs(netPL).toLocaleString(), W-PR-10, y+7, 11, ...(plPos ? [100,255,140] : [255,100,100]), 'right', 'bold');
  txt(G.rounds.length + ' rounds played  ‚Ä¢  $' + totalWagered.toLocaleString() + ' wagered  ‚Ä¢  $' + totalWon.toLocaleString() + ' won', PL+10, y+13, 6.5, ...(plPos?[150,220,160]:[220,150,150]), 'left', 'normal');

  y += 23;

  // ‚îÄ‚îÄ Rounds Table ‚îÄ‚îÄ
  if (G.rounds.length > 0) {
    txt('ROUND HISTORY', PL, y+6, 9, ...gold, 'left', 'bold');
    line(PL, y+8, W-PR, y+8, ...gold, 0.4);
    y += 14;

    // Table header
    rect(PL, y, CW, 8, ...felt);
    const cols = [
      { label:'#',        x:PL+3,      w:8,  align:'left'  },
      { label:'BETS PLACED',x:PL+13,   w:62, align:'left'  },
      { label:'RESULT',   x:PL+77,     w:22, align:'center'},
      { label:'WAGERED',  x:PL+101,    w:24, align:'right' },
      { label:'WON',      x:PL+127,    w:24, align:'right' },
      { label:'NET',      x:PL+153,    w:20, align:'right' },
      { label:'BALANCE',  x:W-PR-3,    w:22, align:'right' }
    ];
    cols.forEach(c => txt(c.label, c.x+(c.align==='right'?c.w:c.align==='center'?c.w/2:0), y+5.5, 6, ...gold, c.align, 'bold'));
    y += 10;

    // Rows
    G.rounds.forEach((r, i) => {
      const rh = Math.max(9, Math.ceil(r.bets.length / 2) * 4.5 + 5);
      const even = i % 2 === 0;
      rect(PL, y, CW, rh, ...(even ? [15,35,20] : [12,28,16]));

      // Round number
      txt(String(r.round), PL+3, y+rh/2+1.5, 7, ...white, 'left', 'bold');

      // Bets (stacked, 2 per line)
      const betStrs = r.bets.map(b => b.label + ' ($' + b.amount.toLocaleString() + ')');
      betStrs.forEach((bs, bi) => {
        const bRow = Math.floor(bi/2), bCol = bi%2;
        const bx = PL+13 + bCol*30;
        const by = y + 4.5 + bRow*4.5;
        txt(bs, bx, by, 5.5, ...lightGrey, 'left', 'normal');
      });

      // Result number with colour circle
      const rc = r.resultColor;
      const circX = PL+77+11, circY = y+rh/2;
      doc.setFillColor(...(rc==='red'?[192,57,43]:rc==='black'?[30,30,30]:[26,92,42]));
      doc.circle(circX, circY, 4.5, 'F');
      doc.setDrawColor(201,168,76); doc.setLineWidth(0.25); doc.circle(circX, circY, 4.5, 'S');
      txt(String(r.result), circX, circY+1.8, 6.5, 245,240,232, 'center', 'bold');

      // Amounts
      txt('$'+r.totalBet.toLocaleString(), PL+101+24, y+rh/2+1.5, 7, ...white, 'right', 'normal');
      txt('$'+r.totalWin.toLocaleString(), PL+127+24, y+rh/2+1.5, 7, r.totalWin>0?100:180, r.totalWin>0?220:180, r.totalWin>0?120:180, 'right', 'bold');
      const nc = r.net>=0?[80,220,100]:[220,80,80];
      txt((r.net>=0?'+':'')+' $'+r.net.toLocaleString(), PL+153+20, y+rh/2+1.5, 7, ...nc, 'right', 'bold');
      txt('$'+r.balanceAfter.toLocaleString(), W-PR-3, y+rh/2+1.5, 6.5, ...gold, 'right', 'normal');

      y += rh;

      // Check if we need a new page
      if (y > 260) {
        doc.addPage();
        rect(0,0,210,297,...dark);
        rect(0,0,210,1.2,...gold);
        y = 15;
      }
    });

    // Table footer line
    doc.setDrawColor(...gold); doc.setLineWidth(0.3);
    doc.line(PL, y, W-PR, y);
    y += 6;

    // Totals row
    rect(PL, y, CW, 10, ...felt);
    txt('TOTALS', PL+3, y+7, 7.5, ...gold, 'left', 'bold');
    txt('$'+totalWagered.toLocaleString(), PL+101+24, y+7, 8, ...white, 'right', 'bold');
    txt('$'+totalWon.toLocaleString(), PL+127+24, y+7, 8, totalWon>totalWagered?100:200, totalWon>totalWagered?220:200, totalWon>totalWagered?120:200, 'right', 'bold');
    const tnc = netPL>=0?[80,220,100]:[220,80,80];
    txt((netPL>=0?'+':'')+' $'+netPL.toLocaleString(), PL+153+20, y+7, 8, ...tnc, 'right', 'bold');
    txt('$'+closeBal.toLocaleString(), W-PR-3, y+7, 8, ...gold, 'right', 'bold');
    y += 18;
  } else {
    rect(PL, y, CW, 18, 15, 35, 20);
    txt('No rounds played this session.', W/2, y+11, 9, ...grey, 'center', 'italic');
    y += 26;
  }

  // ‚îÄ‚îÄ Footer ‚îÄ‚îÄ
  if (y > 270) { doc.addPage(); rect(0,0,210,297,...dark); rect(0,0,210,1.2,...gold); y=15; }
  rect(0, 270, 210, 27, ...felt);
  rect(0, 270, 210, 0.8, ...gold);
  txt('NFC ROULETTE  ‚Ä¢  For entertainment purposes only. Play responsibly.', W/2, 280, 6.5, ...grey, 'center', 'normal');
  txt('This receipt is system-generated and valid without signature.', W/2, 286, 6, ...grey, 'center', 'normal');
  txt(receiptNo + '  ‚Ä¢  ' + fmtDate(new Date()) + ' ' + fmtTime(new Date()), W/2, 292, 5.5, 120,100,60, 'center', 'normal');

  // Save
  const fname = 'NFC-Roulette-Receipt-' + (G.name||'Player').replace(/\s+/g,'-') + '-' + new Date().toISOString().slice(0,10) + '.pdf';
  doc.save(fname);
  toast('‚úì Receipt downloaded!');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
buildGrid();
drawWheel(0);
</script>
</body>
</html>
